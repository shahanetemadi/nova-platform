<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>BNB Register & Purchase</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/ethers@6.8.1/dist/ethers.umd.min.js"></script>

<style>
body {
  background: radial-gradient(circle at bottom, #020111, #000);
  color: #fff;
  font-family: sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
}
.box {
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(12px);
  padding: 30px;
  border-radius: 16px;
  width: 320px;
  text-align: center;
}
button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border: none;
  border-radius: 10px;
  font-size: 16px;
  cursor: pointer;
}
.connect { background: #f3ba2f; color:#000; }
.reg { background: #4caf50; color:#fff; }
.buy { background: #2196f3; color:#fff; }
.status { margin-top: 15px; font-size: 14px; opacity: .9; }
</style>
</head>

<body>

<div class="box">
  <h2>BNB Moon System üåô</h2>

  <button class="connect" onclick="connectWallet()">Connect Wallet</button>
  <button class="reg" onclick="register()">Register (2$ BNB)</button>
  <button class="buy" onclick="purchase()">Purchase (10$ BNB)</button>

  <div class="status" id="status">Wallet not connected</div>
</div>

<script>
const CONTRACT_ADDRESS = "0x3810099D2D61e0399d07a3bad4e796A3De82ff27";
const BNB_USD_FEED = "0x0567F2323251f0Aab15c8dFb1967E4e8A7D42aeE"; // Chainlink BNB/USD

const CONTRACT_ABI = [
  "function Register(string username) payable",
  "function Purchase(string refer1, string refer2) payable"
];

const PRICE_ABI = [
  "function latestRoundData() view returns (uint80,int256,uint256,uint256,uint80)"
];

let provider, signer, contract;

async function connectWallet() {
  if (!window.ethereum) return alert("MetaMask ŸÜÿµÿ® ŸÜ€åÿ≥ÿ™");

  await ethereum.request({ method: "eth_requestAccounts" });
  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();

  const network = await provider.getNetwork();
  if (network.chainId !== 56n) {
    alert("ŸÑÿ∑ŸÅÿß ÿ¥ÿ®⁄©Ÿá ÿ±ÿß ÿ±Ÿà€å BNB Chain ŸÇÿ±ÿßÿ± ÿØŸá€åÿØ");
    return;
  }

  contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
  document.getElementById("status").innerText = "Wallet connected ‚úÖ";
}

async function getBNBAmount(usd) {
  const priceFeed = new ethers.Contract(BNB_USD_FEED, PRICE_ABI, provider);
  const data = await priceFeed.latestRoundData();
  const price = Number(data[1]) / 1e8; // BNB price in USD
  const bnb = usd / price;
  return ethers.parseEther(bnb.toFixed(6));
}

async function register() {
  const username = prompt("Username:");
  if (!username) return;

  const value = await getBNBAmount(2);
  const tx = await contract.Register(username, { value });
  document.getElementById("status").innerText = "Register tx sent...";
  await tx.wait();
  document.getElementById("status").innerText = "Registered successfully ‚úÖ";
}

async function purchase() {
  const ref1 = prompt("Ref 1 username:");
  const ref2 = prompt("Ref 2 username:");

  const value = await getBNBAmount(10);
  const tx = await contract.Purchase(ref1 || "", ref2 || "", { value });
  document.getElementById("status").innerText = "Purchase tx sent...";
  await tx.wait();
  document.getElementById("status").innerText = "Purchase successful üöÄ";
}
</script>

</body>
</html>
