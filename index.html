<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS = "0x3810099D2D61e0399d07a3bad4e796A3De82ff27";

const ABI = [
  {
    "inputs": [],
    "name": "UserCount",
    "outputs": [{"internalType":"uint256","name":"count","type":"uint256"}],
    "stateMutability":"view",
    "type":"function"
  },
  {
    "inputs":[{"internalType":"string","name":"username","type":"string"}],
    "name":"Register",
    "outputs":[],
    "stateMutability":"payable",
    "type":"function"
  },
  {
    "inputs":[],
    "name":"withdraw",
    "outputs":[],
    "stateMutability":"nonpayable",
    "type":"function"
  }
];

let provider, signer, contract, userAddress;

/* ================= WALLET ================= */
async function connectWallet() {
  try {
    let ethProvider = null;

    if (window.ethereum) {
      ethProvider = window.ethereum;
    } else if (window.safepal?.ethereum) {
      ethProvider = window.safepal.ethereum;
    } else {
      alert("❌ Wallet not detected. Use SafePal browser.");
      return;
    }

    await ethProvider.request({ method: "eth_requestAccounts" });

    provider = new ethers.providers.Web3Provider(ethProvider);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();

    document.getElementById("walletStatus").innerText =
      "Connected: " + userAddress;

    initContract();

  } catch (e) {
    alert("Wallet connection failed");
    console.error(e);
  }
}

/* ================= SIGN ================= */
async function signLogin() {
  if (!signer) {
    alert("Connect wallet first");
    return;
  }

  const message = "Login to NOVA Platform";
  await signer.signMessage(message);

  document.getElementById("dashboard").classList.remove("hidden");
}

/* ================= CONTRACT ================= */
function initContract() {
  contract = new ethers.Contract(
    CONTRACT_ADDRESS,
    ABI,
    signer
  );

  loadDashboard();
}

async function loadDashboard() {
  try {
    const count = await contract.UserCount();
    document.getElementById("userCount").innerText = count.toString();
    document.getElementById("walletAddr").innerText = userAddress;
  } catch (e) {
    console.error(e);
  }
}

/* ================= ACTIONS ================= */
async function register() {
  try {
    const username = document.getElementById("username").value;
    if (!username) return alert("Enter username");

    const tx = await contract.Register(username, {
      value: ethers.utils.parseEther("2")
    });
    await tx.wait();

    alert("✅ Registered successfully");

  } catch (e) {
    alert("Register failed");
    console.error(e);
  }
}

async function withdraw() {
  try {
    const tx = await contract.withdraw();
    await tx.wait();
    alert("Withdraw done");
  } catch (e) {
    alert("Withdraw failed");
    console.error(e);
  }
}
</script>
